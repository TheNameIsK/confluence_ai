<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confluence AI Chatbot</title>
    <!-- Add Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Add DOMPurify for security -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-header {
            background: linear-gradient(135deg, #0052cc 0%, #0065ff 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        .chat-header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        .chat-header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        .space-selector {
            position: absolute;
            top: 50px;
            right: 20px;
        }
        .space-selector select {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 12px;
        }
        .space-selector select option {
            background: #0052cc;
            color: white;
        }
        .sync-button {
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .sync-button button {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sync-button button:hover {
            background: rgba(255,255,255,0.3);
        }
        .sync-button button:disabled {
            background: rgba(255,255,255,0.1);
            cursor: not-allowed;
            opacity: 0.5;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }
        .message.user {
            justify-content: flex-end;
        }
        .message.bot {
            justify-content: flex-start;
        }
        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .message.user .message-content {
            background: #0052cc;
            color: white;
            border-bottom-right-radius: 5px;
        }
        .message.bot .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* New style for pending action messages */
        .message.bot.pending-action .message-content {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #2196f3;
            color: #1565c0;
            position: relative;
        }
        
        .message.bot.pending-action .message-content::before {
            content: "‚ö° Action Required";
            position: absolute;
            top: -12px;
            left: 15px;
            background: #2196f3;
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Markdown styling for bot messages */
        .message.bot .message-content h1,
        .message.bot .message-content h2,
        .message.bot .message-content h3,
        .message.bot .message-content h4,
        .message.bot .message-content h5,
        .message.bot .message-content h6 {
            color: #0052cc;
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }
        
        /* Special styling for pending action messages headers */
        .message.bot.pending-action .message-content h1,
        .message.bot.pending-action .message-content h2,
        .message.bot.pending-action .message-content h3,
        .message.bot.pending-action .message-content h4,
        .message.bot.pending-action .message-content h5,
        .message.bot.pending-action .message-content h6 {
            color: #1565c0;
        }
        
        .message.bot .message-content h1 { font-size: 1.5em; }
        .message.bot .message-content h2 { font-size: 1.3em; }
        .message.bot .message-content h3 { font-size: 1.2em; }
        .message.bot .message-content h4 { font-size: 1.1em; }
        .message.bot .message-content h5 { font-size: 1em; }
        .message.bot .message-content h6 { font-size: 0.9em; }
        
        .message.bot .message-content ul,
        .message.bot .message-content ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }
        
        .message.bot .message-content li {
            margin: 0.25em 0;
        }
        
        .message.bot .message-content p {
            margin: 0.5em 0;
        }
        
        .message.bot .message-content strong {
            font-weight: 600;
            color: #0052cc;
        }
        
        /* Special styling for pending action messages strong text */
        .message.bot.pending-action .message-content strong {
            color: #1565c0;
        }
        
        .message.bot .message-content em {
            font-style: italic;
            color: #666;
        }
        
        .message.bot .message-content code {
            background: #f8f9fa;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: #d63384;
        }
        
        .message.bot .message-content pre {
            background: #f8f9fa;
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
            margin: 0.5em 0;
        }
        
        .message.bot .message-content pre code {
            background: none;
            padding: 0;
            color: #333;
        }
        
        .message.bot .message-content blockquote {
            border-left: 4px solid #0052cc;
            margin: 0.5em 0;
            padding: 0.5em 1em;
            background: #f8f9fa;
            font-style: italic;
        }
        
        /* Special styling for pending action messages blockquotes */
        .message.bot.pending-action .message-content blockquote {
            border-left: 4px solid #1565c0;
            background: rgba(255,255,255,0.5);
        }
        
        .message.bot .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.5em 0;
        }
        
        .message.bot .message-content th,
        .message.bot .message-content td {
            border: 1px solid #ddd;
            padding: 0.5em;
            text-align: left;
        }
        
        .message.bot .message-content th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            flex-shrink: 0;
        }
        .message.user .message-avatar {
            background: #0052cc;
            color: white;
        }
        .message.bot .message-avatar {
            background: #28a745;
            color: white;
        }
        
        /* Special avatar styling for pending action messages */
        .message.bot.pending-action .message-avatar {
            background: #2196f3;
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .search-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            padding: 8px 12px;
            background: #e9ecef;
            border-radius: 12px;
        }
        
        /* Special styling for pending action messages search info */
        .message.bot.pending-action .search-info {
            background: rgba(255,255,255,0.7);
            color: #1565c0;
        }
        
        .results-section {
            margin-top: 15px;
        }
        .results-header {
            font-weight: bold;
            color: #0052cc;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        /* Special styling for pending action messages results header */
        .message.bot.pending-action .results-header {
            color: #1565c0;
        }
        
        .result-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        .result-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        .result-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .result-title a {
            color: #0052cc;
            text-decoration: none;
            font-size: 14px;
        }
        .result-title a:hover {
            text-decoration: underline;
        }
        .result-meta {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
        }
        .result-excerpt {
            font-size: 12px;
            color: #333;
            line-height: 1.3;
        }
        .chat-input {
            display: flex;
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            align-items: center;
        }
        .chat-input input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        .chat-input input:focus {
            border-color: #0052cc;
        }
        .chat-input button {
            margin-left: 10px;
            padding: 15px 25px;
            background: #0052cc;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        .chat-input button:hover {
            background: #0065ff;
        }
        .chat-input button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .typing-indicator {
            display: none;
            padding: 15px 20px;
            background: white;
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .typing-dots {
            display: flex;
            align-items: center;
        }
        .typing-dots span {
            height: 8px;
            width: 8px;
            background: #999;
            border-radius: 50%;
            margin-right: 5px;
            animation: typing 1.4s infinite;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .welcome-message h3 {
            color: #0052cc;
            margin-bottom: 10px;
        }
        .example-questions {
            margin-top: 20px;
        }
        .example-questions button {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .example-questions button:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="sync-button">
                <button id="syncButton" onclick="syncData()" title="Sync latest data from Confluence">üîÑ Sync</button>
            </div>
            <h1>ü§ñ Confluence AI Assistant</h1>
            <p>Ask me anything about your Confluence documentation</p>
            <div class="space-selector">
                <select id="spaceFilter">
                    <option value="">All Spaces</option>
                </select>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <h3>üëã Welcome! How can I help you today?</h3>
                <p>I can help you find information from your Confluence documentation. Ask me about processes, policies, guides, or any topic you need help with.</p>
                <div class="example-questions">
                    <button onclick="askExample('How do I submit a vacation request?')">How do I submit a vacation request?</button>
                    <button onclick="askExample('What is our deployment process?')">What is our deployment process?</button>
                    <button onclick="askExample('Where can I find the employee handbook?')">Where can I find the employee handbook?</button>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="message bot">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Type your message..." />
            <button id="sendButton" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let isWaitingForResponse = false;
        
        // Configure marked.js for better markdown rendering
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });
        }
        
        // Load spaces on page load
        window.onload = function() {
            loadSpaces();
        };
        
        // Send message on Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !isWaitingForResponse) {
                sendMessage();
            }
        });
        
        async function loadSpaces() {
            try {
                const response = await fetch('/api/spaces');
                const data = await response.json();
                
                const spaceFilter = document.getElementById('spaceFilter');
                data.spaces.forEach(space => {
                    const option = document.createElement('option');
                    option.value = space.key;
                    option.textContent = space.name;
                    spaceFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load spaces:', error);
            }
        }
        
        function askExample(question) {
            document.getElementById('messageInput').value = question;
            sendMessage();
        }
        
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            const spaceKey = document.getElementById('spaceFilter').value;
            
            if (!message || isWaitingForResponse) return;
            
            // Add user message to chat
            addMessage(message, 'user');
            
            // Clear input and show typing indicator
            messageInput.value = '';
            showTypingIndicator();
            
            // Disable input
            isWaitingForResponse = true;
            document.getElementById('sendButton').disabled = true;
            messageInput.disabled = true;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        space_key: spaceKey || null
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    hideTypingIndicator();
                    addBotResponse(data);
                } else {
                    hideTypingIndicator();
                    addMessage(`‚ùå Error: ${data.error}`, 'bot');
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage(`‚ùå Chat failed: ${error.message}`, 'bot');
            } finally {
                // Re-enable input
                isWaitingForResponse = false;
                document.getElementById('sendButton').disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }
        
        function addMessage(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = sender === 'user' ? 'üë§' : 'ü§ñ';
            
            // For user messages, keep as plain text
            // For bot messages, parse markdown if it's just a simple message
            let content = message;
            if (sender === 'bot' && typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                try {
                    const markdownHtml = marked.parse(message);
                    content = DOMPurify.sanitize(markdownHtml);
                } catch (e) {
                    // If markdown parsing fails, use original message
                    content = message;
                }
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${content}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addBotResponse(data) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            // Check if this is a pending action message
            const hasPendingAction = data.pending_action && 
                (data.pending_action.type === 'create_page' || 
                 data.pending_action.type === 'update_page' || 
                 data.pending_action.type === 'delete_page');
            
            messageDiv.className = hasPendingAction ? 'message bot pending-action' : 'message bot';
            
            // Parse the response through markdown
            let responseContent = data.response;
            if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                try {
                    const markdownHtml = marked.parse(responseContent);
                    responseContent = DOMPurify.sanitize(markdownHtml);
                } catch (e) {
                    // If markdown parsing fails, use original response
                    responseContent = data.response;
                }
            }
            
            let content = `<div class="message-content">${responseContent}`;
            
            if (data.search_performed && data.search_query) {
                content += `<div class="search-info">üîç Searched for: ${data.search_query}</div>`;
            }
            
            if (data.results && data.results.length > 0) {
                content += `
                    <div class="results-section">
                        <div class="results-header">üìÑ Related Documents (${data.total_results})</div>
                `;
                
                data.results.forEach(result => {
                    content += `
                        <div class="result-item">
                            <div class="result-title">
                                <a href="${result.url}" target="_blank">${result.title}</a>
                            </div>
                            <div class="result-meta">
                                üìÅ ${result.space} ‚Ä¢ ${result.type} ‚Ä¢ Modified: ${formatDate(result.last_modified)}
                            </div>
                            <div class="result-excerpt">${result.excerpt}</div>
                        </div>
                    `;
                });
                
                content += `</div>`;
            }
            
            content += `</div>`;
            
            // Use different avatar for pending actions
            const avatar = hasPendingAction ? '‚ö°' : 'ü§ñ';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                ${content}
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return 'Unknown';
            }
        }
        
        async function syncData() {
            const syncButton = document.getElementById('syncButton');
            const originalText = syncButton.innerHTML;
            
            // Disable button and show loading state
            syncButton.disabled = true;
            syncButton.innerHTML = '‚è≥ Syncing...';
            
            try {
                const response = await fetch('/api/sync/incremental', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show success feedback
                    syncButton.innerHTML = '‚úÖ Synced!';
                    
                    // Add system message to chat
                    const stats = data.stats;
                    const message = `üîÑ Sync completed: ${stats.added} added, ${stats.updated} updated, ${stats.deleted} deleted`;
                    addMessage(message, 'bot');
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        syncButton.innerHTML = originalText;
                        syncButton.disabled = false;
                    }, 2000);
                } else {
                    // Show error feedback
                    syncButton.innerHTML = '‚ùå Failed';
                    addMessage(`‚ùå Sync failed: ${data.error}`, 'bot');
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        syncButton.innerHTML = originalText;
                        syncButton.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                // Show error feedback
                syncButton.innerHTML = '‚ùå Failed';
                addMessage(`‚ùå Sync failed: ${error.message}`, 'bot');
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    syncButton.innerHTML = originalText;
                    syncButton.disabled = false;
                }, 2000);
            }
        }
    </script>
</body>
</html>